<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Synthomer CSV Date Fixer</title>
<style>
body { font-family:sans-serif; margin:40px; max-width:800px; }
h2 { color:#0055aa; }
button { padding:10px 25px; margin-top:15px; cursor:pointer; }
.section { margin-bottom:20px; }
</style>
</head>
<body>

<h2>Synthomer CSV Date Fixer (PC1 / P11)</h2>

<div class="section">
  <strong>Select Site:</strong><br><br>
  <label>
    <input type="radio" name="site" value="PC1" checked>
    PC1 System
  </label><br>
  <label>
    <input type="radio" name="site" value="P11">
    P11 System
  </label>
</div>

<div class="section">
  <input type="file" id="fileInput" accept=".csv">
</div>

<button onclick="processFile()">Fix Dates & Download</button>

<script>
function processLine(line, isHeader) {
    if (isHeader) return line;

    function fixDateWithTime(s, col) {
        const re = new RegExp(
          '^((?:"(?:[^"]|"")*",){' + (col-1) + '}")' +
          '(\\d{2})\\/(\\d{2})\\/(\\d{4}) \\d{2}:\\d{2}:\\d{2}(".*)$'
        );
        return s.replace(re, (m,p1,d,mth,y,p2) => `${p1}${y}-${mth}-${d}${p2}`);
    }

    function fixDateOnly(s, col) {
        const re = new RegExp(
          '^((?:"(?:[^"]|"")*",){' + (col-1) + '}")' +
          '(\\d{2})\\/(\\d{2})\\/(\\d{4})(".*)$'
        );
        return s.replace(re, (m,p1,d,mth,y,p2) => `${p1}${y}-${mth}-${d}${p2}`);
    }

    let out = line;
    out = fixDateWithTime(out, 3);
    out = fixDateWithTime(out, 4);
    out = fixDateOnly(out, 11);
    out = fixDateOnly(out, 13);
    return out;
}

function getSelectedSite() {
    const radios = document.getElementsByName("site");
    for (let r of radios) if (r.checked) return r.value;
    return "unknown";
}

function todayISO() {
    const d = new Date();
    return d.toISOString().split("T")[0];
}

function processFile() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) { alert("Please choose a CSV file."); return; }

    const site = getSelectedSite();
    const date = todayISO();
    const outName = `synthomer_${site}_ESKER_${date}.csv`;

    const reader = new FileReader();
    reader.onload = function(e) {
        const lines = e.target.result.split(/\r?\n/);
        const outLines = lines.map((l,i) => processLine(l, i === 0));
        const out = outLines.join("\n");

        const blob = new Blob([out], {type:"text/csv"});
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = outName;
        a.click();
    };
    reader.readAsText(file);
}
</script>

</body>
</html>
