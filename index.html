<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Synthomer CSV Date Fixer</title>
<style>
body { font-family:sans-serif; margin:40px; max-width:850px; }
h2 { color:#0055aa; }
button { padding:10px 25px; margin-top:15px; cursor:pointer; }
.section { margin-bottom:20px; }
label { display:block; margin-top:6px; }
input[type=file] { margin-top:10px; }
.summaryBox {
  background:#eef7ff; border:1px solid #aaccee; padding:12px; margin-top:20px;
  white-space:pre-line;
}
#saveBtn { display:none; }
</style>
</head>
<body>

<h2>Synthomer CSV Date Fixer (PC1 / P11)</h2>

<!-- Step 1: Select Site -->
<div class="section">
  <strong>1. Select Site:</strong><br><br>
  <label><input type="radio" name="site" value="PC1" checked> PC1 System</label>
  <label><input type="radio" name="site" value="P11"> P11 System</label>
</div>

<!-- Step 2: Choose CSV File -->
<div class="section">
  <strong>2. Choose CSV File:</strong><br>
  <input type="file" id="fileInput" accept=".csv">
</div>

<!-- Step 3: Fix Dates -->
<button id="fixBtn" onclick="fixDates()">3. Fix Dates</button>

<!-- Step 4: Summary -->
<div id="summary" class="summaryBox" style="display:none;"></div>

<!-- Step 5: Save As Dialog -->
<button id="saveBtn" onclick="saveFile()">4. Save As…</button>

<script>
// Global memory for processed output
let processedCSV = "";

// Helper: which site selected?
function getSelectedSite() {
  const radios = document.getElementsByName("site");
  for (let r of radios) if (r.checked) return r.value;
  return "unknown";
}

// Today's date yyyy-mm-dd
function todayISO() {
  return new Date().toISOString().split("T")[0];
}

// Transform a line in the CSV
function processLine(line, isHeader, stats) {
  if (isHeader) {
    stats.skipped++;
    return line;
  }

  let original = line;
  let out = line;

  function fixDateWithTime(s, col) {
    const re = new RegExp(
      '^((?:"(?:[^"]|"")*",){' + (col-1) + '}")' +
      '(\\d{2})\\/(\\d{2})\\/(\\d{4}) \\d{2}:\\d{2}:\\d{2}(".*)$'
    );
    return s.replace(re,(m,p1,d,mth,y,p2)=>`${p1}${y}-${mth}-${d}${p2}`);
  }

  function fixDateOnly(s, col) {
    const re = new RegExp(
      '^((?:"(?:[^"]|"")*",){' + (col-1) + '}")' +
      '(\\d{2})\\/(\\d{2})\\/(\\d{4})(".*)$'
    );
    return s.replace(re,(m,p1,d,mth,y,p2)=>`${p1}${y}-${mth}-${d}${p2}`);
  }

  out = fixDateWithTime(out, 3);
  out = fixDateWithTime(out, 4);
  out = fixDateOnly(out, 11);
  out = fixDateOnly(out, 13);

  if (out !== original) stats.changed++;
  else stats.unchanged++;

  return out;
}

// MAIN: Process the file
function fixDates() {
  const file = document.getElementById('fileInput').files[0];
  if (!file) {
    alert("Please choose a CSV file first.");
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    const text = e.target.result;
    const lines = text.split(/\r?\n/);

    const stats = { total: lines.length, changed: 0, unchanged: 0, skipped: 0 };

    const outLines = lines.map((l,i)=>processLine(l, i===0, stats));
    processedCSV = outLines.join("\n");

    // Show summary
    const sum = document.getElementById("summary");
    const site = getSelectedSite();
    const date = todayISO();
    const outName = `synthomer_${site}_ESKER_${date}.csv`;

    sum.style.display = "block";
    sum.textContent =
      `Total lines: ${stats.total}\n` +
      `Header skipped: ${stats.skipped}\n` +
      `Changed lines: ${stats.changed}\n` +
      `Unchanged lines: ${stats.unchanged}\n` +
      `Output filename: ${outName}`;

    // Enable Save As button
    document.getElementById("saveBtn").style.display = "inline-block";
  };

  reader.readAsText(file);
}

// SAVE AS (forces Save-As dialog)
function saveFile() {
  if (!processedCSV) {
    alert("Nothing to save — please fix dates first.");
    return;
  }

  const site = getSelectedSite();
  const date = todayISO();
  const outName = `synthomer_${site}_ESKER_${date}.csv`;

  const blob = new Blob([processedCSV], {type:"text/csv"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = outName;

  // Force Save-As dialog if browser is configured for it
  a.click();
}
</script>

</body>
</html>
