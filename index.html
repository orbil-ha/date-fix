<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>ESKER .csv Date Fix</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
/* ------------------------------------
   Apple‑Inspired Minimal Clean Styling
------------------------------------- */
body {
    margin: 0;
    padding: 40px;
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Arial, sans-serif;
    background: #f5f5f7;
    color: #1d1d1f;
    display: flex;
    justify-content: center;
}

.container {
    max-width: 820px;
    width: 100%;
}

h1 {
    font-size: 32px;
    text-align: center;
    font-weight: 600;
    margin-bottom: 25px;
}

.card {
    background: white;
    border-radius: 18px;
    padding: 24px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
}

.section {
    margin-bottom: 25px;
}

.section strong {
    display: block;
    font-size: 17px;
    margin-bottom: 12px;
}

.segmented {
    display: inline-flex;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid #c7c7cc;
}

.segment {
    padding: 10px 22px;
    cursor: pointer;
    background: #f2f2f7;
}

.segment.active {
    background: #0071e3;
    color: white;
}

input[type="date"],
input[type="file"] {
    width: 100%;
    padding: 12px;
    border: 1px solid #d2d2d7;
    border-radius: 10px;
    font-size: 16px;
    margin-top: 8px;
}

button {
    width: 100%;
    padding: 14px;
    font-size: 17px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    margin-top: 12px;
    background: #0071e3;
    color: white;
    font-weight: 500;
}
button:hover {
    background: #0a84ff;
}

.summaryBox {
    white-space: pre-line;
    padding: 16px;
    border-radius: 14px;
    background: #f0f6ff;
    border: 1px solid #aaccee;
    margin-top: 15px;
    font-family: Menlo, Consolas, monospace;
    display: none;
}
</style>
</head>

<body>
<div class="container">

<h1>ESKER .csv Date Fix</h1>

<div class="card">

    <!-- STEP 1 -->
    <div class="section">
        <strong>1. Select Site</strong>
        <div class="segmented">
            <div class="segment active" data-site="PC1">PC1 System</div>
            <div class="segment" data-site="P11">P11 System</div>
        </div>
    </div>

    <!-- STEP 2 -->
    <div class="section">
        <strong>2. Select Date for Output Filename</strong>
        <input type="date" id="dateInput">
    </div>

    <!-- STEP 3 -->
    <div class="section">
        <strong>3. Choose CSV File</strong>
        <input type="file" id="fileInput" accept=".csv">
    </div>

    <!-- STEP 4 -->
    <button id="fixBtn">4. Fix Dates</button>

    <div id="summary" class="summaryBox"></div>

    <button id="saveBtn" style="display:none;">5. Download</button>
    <button id="mailBtn" style="display:none;">Mail to: libor.martinek@synthomer.com</button>

</div>
</div>

<script>
let selectedSite = "PC1";
let processedCSV = "";

// Apple-style segmented control
document.querySelectorAll('.segment').forEach(seg => {
    seg.addEventListener("click", () => {
        document.querySelectorAll('.segment').forEach(s => s.classList.remove('active'));
        seg.classList.add('active');
        selectedSite = seg.dataset.site;
    });
});

// Set today's date
document.getElementById("dateInput").value = new Date().toISOString().split("T")[0];

// Your original date-fix logic (unchanged)
function processLine(line, isHeader, stats) {
    if (isHeader) { stats.skipped++; return line; }

    let original = line;
    let out = line;

    function fixDateWithTime(s, col) {
        const re = new RegExp(
          '^((?:"(?:[^"]|"")*",){' + (col-1) + '}")' +
          '(\\d{2})\\/(\\d{2})\\/(\\d{4}) \\d{2}:\\d{2}:\\d{2}(".*)$'
        );
        return s.replace(re,(m,p1,d,mth,y,p2)=>`${p1}${y}-${mth}-${d}${p2}`);
    }

    function fixDateOnly(s, col) {
        const re = new RegExp(
          '^((?:"(?:[^"]|"")*",){' + (col-1) + '}")' +
          '(\\d{2})\\/(\\d{2})\\/(\\d{4})(".*)$'
        );
        return s.replace(re,(m,p1,d,mth,y,p2)=>`${p1}${y}-${mth}-${d}${p2}`);
    }

    out = fixDateWithTime(out, 3);
    out = fixDateWithTime(out, 4);
    out = fixDateOnly(out, 11);
    out = fixDateOnly(out, 13);

    if (out !== original) stats.changed++; else stats.unchanged++;
    return out;
}

// MAIN FIX FUNCTION
document.getElementById("fixBtn").onclick = function() {
    const file = document.getElementById("fileInput").files[0];
    if (!file) return alert("Please select a CSV file.");

    const reader = new FileReader();
    reader.onload = function(e) {
        const lines = e.target.result.split(/\r?\n/);
        const stats = { total: lines.length, changed: 0, unchanged: 0, skipped: 0 };

        const outLines = lines.map((l,i) => processLine(l, i===0, stats));
        processedCSV = outLines.join("\n");

        const date = document.getElementById("dateInput").value;
        const outName = `synthomer_${selectedSite}_ESKER_${date}.csv`;

        const summary = document.getElementById("summary");
        summary.style.display = "block";
        summary.textContent =
            `Total lines: ${stats.total}\n` +
            `Header skipped: ${stats.skipped}\n` +
            `Changed lines: ${stats.changed}\n` +
            `Unchanged lines: ${stats.unchanged}\n` +
            `Output filename: ${outName}`;

        document.getElementById("saveBtn").style.display = "block";
        document.getElementById("mailBtn").style.display = "block";
    };
    reader.readAsText(file);
};

document.getElementById("saveBtn").onclick = function() {
    if (!processedCSV) return;
    const date = document.getElementById("dateInput").value;
    const outName = `synthomer_${selectedSite}_ESKER_${date}.csv`;
    const blob = new Blob([processedCSV], {type:"text/csv"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = outName;
    a.click();
};

document.getElementById("mailBtn").onclick = function() {
    const date = document.getElementById("dateInput").value;
    const outName = `synthomer_${selectedSite}_ESKER_${date}.csv`;
    const subject = encodeURIComponent(`ESKER export for ${selectedSite} – ${date}`);
    const body = encodeURIComponent(`Hello,\n\nPlease attach:\n${outName}\n\nRegards,`);
    window.location.href = `mailto:libor.martinek@synthomer.com?subject=${subject}&body=${body}`;
};
</script>

</body>
</html>
